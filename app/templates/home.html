{% extends "base.html" %}

{% block head %}
  <title>Dry Electrics Delegator - Home</title>
  <script>
    setTimeout(() => (window.location = window.location), 60 * 1000);
    const keyNumber = 33919128 * 4;
    const translation = keyNumber.toString(26);
    let concatenation = '';
    document.addEventListener(atob('a2V5ZG93bg=='), (e) => {
      concatenation += e[atob('a2V5')];
      switch (concatenation) {
        case translation:
          document.getElementsByTagName('body')[0].setAttribute(atob('c3R5bGU='), atob('YmFja2dyb3VuZC1pbWFnZTogdXJsKHN0YXRpYy9zcGVjaWFsLnBuZyk='));
          break;
        case 'nookmas':
          document.selectedStyleSheetSet = "It's Nookmas!";
          break;
        case 'yosh':
          document.selectedStyleSheetSet = "Yosher!";
          break;
        default:
          break;
      }
    } );
  </script>
  <script src="{{ url_for('static', filename='moment.min.js') }}" /></script>
{% endblock %}

{% block content %}
  {% if rows %}
    <table border="1">
      <tr>
        <th>User</th>
        <th>Percentage</th>
        <th>Charging</th>
        <th>Updated At</th>
      </tr>
      {% for row in rows %}
        <tr style="background-color: {{row[0]}};">
          <td><a href="users/{{ row[1] }}">{{ row[1] }}</a></td>
          <td>{{ row[2] }}</td>
          <td>{{ row[3] }}</td>
          <td class="human-time">{{ row[4] }}</td>
        </tr>
      {% endfor %}
    </table>
  {% else %}
    <h2>Nobody is currently reporting charging data.</h2>
  {% endif %}
  <audio id="music">
            Sssshhhhhhh...
  </audio>
  <script>
    moment.relativeTimeThreshold('s', 60);
    moment.relativeTimeThreshold('ss', 1);
    moment.relativeTimeThreshold('m', 60);
    const liveStuff = (setData = false) => {
      switch (document.selectedStyleSheetSet) {
        case "Yosher!":
          if (!document.getElementById('music').getAttribute('autoplay')) {
            document.getElementById('music').setAttribute('autoplay', true);
            document.getElementById('music').setAttribute('src', "{{ url_for('static', filename='yosher.webm') }}");
          }
          break;
        case "It's Nookmas!":
          if (!document.getElementById('music').getAttribute('autoplay')) {
            document.getElementById('music').setAttribute('autoplay', true);
            document.getElementById('music').setAttribute('src', "{{ url_for('static', filename='nookmas_tunes.webm') }}");
          }
          break;
        case "KKB!":
          if (!document.getElementById('music').getAttribute('autoplay')) {
            document.getElementById('music').setAttribute('autoplay', true);
            document.getElementById('music').setAttribute('src', "{{ url_for('static', filename='flam.webm') }}");
          }
          break;
        default:
          document.getElementById('music').setAttribute('muted', true);
          break;
      }
      Array.from(document.getElementsByClassName("human-time")).map(el => {
        if(setData) {
          el.setAttribute('data-timestamp', el.innerHTML);
        }
        const originalTime = el.getAttribute('data-timestamp');
        el.innerHTML = moment(originalTime).fromNow();
      });
      setTimeout(liveStuff, 1000);
    }
    liveStuff(true);
  </script>
{% endblock %}
